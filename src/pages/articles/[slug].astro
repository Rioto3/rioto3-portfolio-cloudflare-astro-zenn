---
// [slug].astro
import lib from 'zenn-markdown-html';
import 'zenn-content-css';
import MainLayout from '../../layouts/MainLayout.astro';
import matter from 'gray-matter';

import "../../styles/global.css";

export async function getStaticPaths() {
  // é™çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½ - ç›´æ¥é–¢æ•°å†…ã§import.globã‚’å‘¼ã³å‡ºã™
  let articleFiles = {};
  
  try {
    // æœ€åˆã®ãƒ‘ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™
    articleFiles = await import.meta.glob('../../content/articles/*.md', { 
      query: '?raw', 
      import: 'default' 
    });
    
    // è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ä»–ã®ãƒ‘ã‚¹ã‚’è©¦ã™
    if (Object.keys(articleFiles).length === 0) {
      articleFiles = await import.meta.glob('../../../content/articles/*.md', { 
        query: '?raw', 
        import: 'default' 
      });
    }
    
    // ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã•ã‚‰ã«æ·±ã„ãƒ‘ã‚¹ã‚‚è©¦ã™
    if (Object.keys(articleFiles).length === 0) {
      articleFiles = await import.meta.glob('../../../../content/articles/*.md', { 
        query: '?raw', 
        import: 'default' 
      });
    }
  } catch (error) {
    console.error("è¨˜äº‹ãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
    articleFiles = {};
  }
  
  // å„è¨˜äº‹ã®ãƒ‘ã‚¹ã¨å†…å®¹ã‚’å‡¦ç†
  const articles = await Promise.all(
    Object.entries(articleFiles).map(async ([path, resolver]) => {
      const rawContent = await resolver();
      const { data, content } = matter(rawContent);
      const slug = path.split('/').pop().replace('.md', '');
      
      return {
        slug,
        frontmatter: data,
        content
      };
    })
  );
  
  // é™çš„ãƒ‘ã‚¹ã‚’è¿”ã™
  return articles.map(article => {
    return {
      params: { slug: article.slug },
      props: {
        title: article.frontmatter.title,
        emoji: article.frontmatter.emoji,
        type: article.frontmatter.type,
        topics: article.frontmatter.topics,
        date: article.frontmatter.date,
        body: article.content
      }
    };
  });
}

const { title, emoji, type, topics, date, body } = Astro.props;
const markdownToHtml = typeof lib === 'function' ? lib : lib.default;
const html = markdownToHtml(body, {
  embedOrigin: "https://embed.zenn.studio"
});

// Twitterã®åŸ‹ã‚è¾¼ã¿ã‚’è¦‹ã¤ã‘ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
function processTwitterEmbeds(html) {
  // TwitteråŸ‹ã‚è¾¼ã¿URLã®ãƒ‘ã‚¿ãƒ¼ãƒ³
  const twitterEmbedPattern = /<a\s+[^>]*?href="https:\/\/twitter\.com\/[^"]*\/status\/[^"]*"[^>]*>.*?<\/a>/g;
  
  // Twitterã®URLãƒ‘ã‚¿ãƒ¼ãƒ³
  const twitterUrlPattern = /https:\/\/twitter\.com\/([^\/]+)\/status\/([^\/\?"]+)/;
  
  // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®ãƒ–ãƒ­ãƒƒã‚¯ã«ç½®æ›
  return html.replace(twitterEmbedPattern, (match) => {
    const urlMatch = match.match(twitterUrlPattern);
    if (urlMatch) {
      const username = urlMatch[1];
      const tweetId = urlMatch[2];
      
      return `
        <div class="twitter-embed-container">
          <blockquote class="twitter-tweet" data-conversation="none" data-theme="light">
            <a href="https://twitter.com/${username}/status/${tweetId}"></a>
          </blockquote>
        </div>
      `;
    }
    return match;
  });
}

// TwitteråŸ‹ã‚è¾¼ã¿ã‚’å‡¦ç†
const processedHtml = processTwitterEmbeds(html);
---

<MainLayout title={`${title} | Rioto3`} description={title}>
  <article class="article-container">
    <!-- è¨˜äº‹ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
    <div class="article-header pb-4 sm:pb-6 mb-4 sm:mb-6 border-b border-[#F7F6F2]">
      <div class="emoji-container mb-3 sm:mb-4">
        <span class="text-4xl sm:text-5xl block">{emoji || "ğŸ“"}</span>
      </div>
      
      <h1 class="text-2xl sm:text-3xl font-bold mb-4 sm:mb-6">{title}</h1>
      
      <div class="meta-container flex flex-wrap items-center gap-2 sm:gap-4 mb-3 sm:mb-4">
        <div class="date-container text-gray-500 text-sm">
          <time datetime={date}>
            {new Date(date || new Date()).toLocaleDateString('ja-JP', {year: 'numeric', month: 'long', day: 'numeric'})}
          </time>
        </div>
        
        <div class="type-container">
          <span class="bg-gray-100 text-gray-800 rounded-full px-3 py-0.5 text-xs sm:text-sm font-medium">
            {type}
          </span>
        </div>
      </div>
      
      <div class="topics-container">
        <div class="flex flex-wrap gap-1.5 sm:gap-2">
          {topics && topics.map((topic: string) => (
            <span class="bg-blue-50 text-blue-700 rounded-full px-2 sm:px-3 py-0.5 text-xs sm:text-sm font-medium">
              {topic}
            </span>
          ))}
        </div>
      </div>
    </div>
    
    <!-- è¨˜äº‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ† -->
    <div class="article-content bg-white rounded-lg p-4 sm:p-6 border border-[#F7F6F2] overflow-hidden">
      <div class="znc prose max-w-none overflow-hidden" id="article-content">
        <Fragment set:html={processedHtml} />
      </div>
    </div>
    
    <!-- è¨˜äº‹ãƒ•ãƒƒã‚¿ãƒ¼éƒ¨åˆ† -->
    <div class="article-footer mt-6 sm:mt-8 text-center">
      <a 
        href="/articles" 
        class="inline-flex items-center text-blue-600 hover:text-blue-800"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 mr-1 sm:mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        è¨˜äº‹ä¸€è¦§ã«æˆ»ã‚‹
      </a>
    </div>
  </article>
</MainLayout>

<!-- TwitteråŸ‹ã‚è¾¼ã¿ç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€æ˜ç¤ºçš„ã«å…ˆã«èª­ã¿è¾¼ã¿ -->
<script is:inline>
  // Twitter widgets JSã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
  window.twttrLoadPromise = new Promise((resolve) => {
    window.twttrResolve = resolve;
    
    const script = document.createElement('script');
    script.setAttribute('src', 'https://platform.twitter.com/widgets.js');
    script.setAttribute('charset', 'utf-8');
    script.onload = () => {
      if (window.twttr) {
        window.twttrResolve(window.twttr);
      }
    };
    document.head.appendChild(script);
  });
</script>

<!-- ZennåŸ‹ã‚è¾¼ã¿è¦ç´ å¯¾å¿œã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script is:inline src="https://embed.zenn.studio/js/listen-embed-event.js"></script>

<script is:inline>
  // DOMæ“ä½œç”¨é–¢æ•°
  function loadTwitterWidgets() {
    // TwitteråŸ‹ã‚è¾¼ã¿ã®å†åˆæœŸåŒ–
    if (window.twttr && window.twttr.widgets) {
      console.log('Rendering Twitter embeds...');
      window.twttr.widgets.load(document.getElementById('article-content'));
    }
  }
  
  // DOMContentLoadedæ™‚ã«å®Ÿè¡Œ
  document.addEventListener('DOMContentLoaded', () => {
    // twttrLoadPromiseãŒè§£æ±ºã•ã‚ŒãŸã‚‰ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’èª­ã¿è¾¼ã‚€
    if (window.twttrLoadPromise) {
      window.twttrLoadPromise.then(() => {
        loadTwitterWidgets();
      });
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ - ç›´æ¥èª­ã¿è¾¼ã¿è©¦è¡Œ
      loadTwitterWidgets();
    }
    
    // é…å»¶ã—ã¦ã‚‚ç¢ºå®Ÿã«èª­ã¿è¾¼ã‚€ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    setTimeout(loadTwitterWidgets, 1000);
    setTimeout(loadTwitterWidgets, 2000);
  });

  // Twitter APIã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  if (window.twttr) {
    window.twttr.ready((twttr) => {
      twttr.events.bind('loaded', function() {
        console.log('Twitter widgets loaded successfully');
      });
    });
  }
</script>

<style is:global>
  /* zncå¤–éƒ¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´ */
  .znc {
    font-size: 0.95rem;
    line-height: 1.75;
  }
  
  /* ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ */
  .znc pre {
    max-width: 100%;
    overflow-x: auto;
  }
  
  /* ç”»åƒã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ */
  .znc img {
    max-width: 100%;
    height: auto;
  }
  
  /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ */
  .znc table {
    display: block;
    width: 100%;
    overflow-x: auto;
  }
  
  /* ãƒ„ã‚¤ãƒ¼ãƒˆåŸ‹ã‚è¾¼ã¿ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  .twitter-embed-container {
    max-width: 550px;
    margin: 1.5em auto;
    overflow: hidden;
  }
  
  .znc .twitter-tweet,
  .znc .twitter-tweet-rendered {
    margin: 1em auto !important;
  }
  
  /* iframeåŸ‹ã‚è¾¼ã¿ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  .znc iframe {
    max-width: 100%;
  }
  
  /* åŸ‹ã‚è¾¼ã¿è¦ç´ ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  .znc .embed-zenn-link,
  .znc .embed-twitter {
    margin: 1.5em auto !important;
    width: 100% !important;
    max-width: 500px;
  }
  
  /* ã‚¹ãƒãƒ›å‘ã‘ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
  @media (max-width: 640px) {
    .znc h1 {
      font-size: 1.5rem;
    }
    .znc h2 {
      font-size: 1.25rem;
    }
    .znc h3 {
      font-size: 1.125rem;
    }
  }
</style>
